<!DOCTYPE html>
<html>

<head>
    <!-- Import Google Icon Font -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Import Materialize CSS -->
    <link type="text/css" rel="stylesheet" href="css/materialize.css" media="screen,projection" />

    <!-- Let browser know website is optimized for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Required JS Libraries -->
    <script type="text/javascript" src="js/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="manifest" href="/icons/site.webmanifest">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#f06c00">
    <link rel="shortcut icon" href="/icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#f06c00">
    <meta name="msapplication-config" content="/icons/browserconfig.xml">
    <meta name="theme-color" content="#f06c00">

    <!-- IOS meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- IconSelect -->
    <link rel="stylesheet" type="text/css" href="/css/iconselect.css?1">
    <script type="text/javascript" src="/js/iconselect.min.js"></script>
    <script type="text/javascript" src="/js/iscroll.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">

    <!-- OpenPGP.js for encryption -->
    <script src="/js/openpgp.min.js"></script>

    <title>NM</title>
</head>

<body>

    <div id="encrypting" class="orange darken-3" data-pkey="theme"
        style="background-image: url(/img/loading.svg) center no-repeat; background-size: 12.5%; left: 0; right: 0; top: 0; bottom: 0; position: fixed; z-index: 9999; text-align: center; font-size: 50px; color: white;">
        <p data-lkey="login.encrypting">Encrypting connection...</p>
    </div>

    <div id="connecting" class="orange darken-3" data-pkey="theme"
        style="background-image: url(/img/loading.svg) center no-repeat; background-size: 12.5%; left: 0; right: 0; top: 0; bottom: 0; position: fixed; z-index: 9999; display: none;">
        &nbsp;
    </div>

    <noscript style="background: white; z-index: 99999; left: 0; right: 0; top: 0; bottom: 0; position: fixed;">
        Enable JavaScript to use NM.
        <br>
        Schakel JavaScript in om NM te kunnen gebruiken.
    </noscript>

    <div class="login orange darken-3" data-pkey="theme"
        style="left: 0; right: 0; top: 0; bottom: 0; position: fixed; z-index: 999;">
        <div class="container">
            &nbsp;
        </div>
        <div class="container" id="loginContainer" style="display: none;">
            <div class="card" id="enterSchoolName">
                <div class="card-image">
                    <a class="btn-floating halfway-fab waves-effect waves-light red disabled proceedto-auth"><i
                            class="material-icons">arrow_forward</i></a>
                </div>
                <div class="card-content">
                    <p data-lkey="login.schoolpicker.welcome">Welcome to NM. Choose your school.</p>
                    <div class="input-field">
                        <i class="material-icons prefix">school</i>
                        <input placeholder="" id="schoolname" type="text" class="autocomplete" data-lpignore="true">
                    </div>
                    <br>
                    <p data-lkey="login.schoolpicker.opensource">NM is open source! Click <a
                            href="https://github.com/NoahvdAa/NM" target="_blank">here</a> to see
                        our GitHub repository.</p>
                    <br>
                    <p><img src="/img/lock.svg" width="25px;">&nbsp;<span data-lkey="login.security.encrypted"></span>
                    </p>
                    <br>
                    <div id="language-selector-schoolpicker"></div>
                </div>
            </div>
            <div class="card" id="authentication" style="display: none;">
                <div class="card-image">
                    <a class="btn-floating halfway-fab waves-effect waves-light left red backto-school"><i
                            class="material-icons">arrow_back</i></a>
                    <a class="btn-floating halfway-fab waves-effect waves-light right red disabled proceedto-login"><i
                            class="material-icons">arrow_forward</i></a>
                </div>
                <div class="card-content">
                    <p id="schoolName"></p>
                    <br>
                    <div class="input-field">
                        <i class="material-icons prefix">person</i>
                        <input placeholder="" id="username" type="text">
                        <label data-lkey="login.auth.username">Username</label>
                    </div>
                    <div class="input-field">
                        <i class="material-icons prefix">lock</i>
                        <input placeholder="" id="password" type="password">
                        <label data-lkey="login.auth.password">Password</label>
                    </div>
                    <div class="row" id="wrongPassword" style="display: none;">
                        <div class="col">
                            <div class="card-panel red">
                                <span class="white-text" data-lkey="login.auth.wrongpassword">
                                    De combinatie van deze gebruikersnaam en dit wachtwoord klopt niet.
                                </span>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div id="language-selector-auth"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container" id="magister" style="display: none;">
        <a href="#" data-target="nav" class="btn-floating red sidenav-trigger hide-on-large-only"><i
                class="material-icons">menu</i></a>
        <a href="#" data-target="calendarPicker"
            class="tab tab-calendar btn-floating blue lighten-2 sidenav-trigger hide-on-large-only"><i
                class="material-icons">date_range</i></a>
        <ul id="nav" class="sidenav sidenav-fixed menu">
            <li>
                <div class="user-view">
                    <div class="background orange darken-3" data-pkey="theme"></div>
                    <a href="#"><img class="circle profilePicture" src="/img/loading.svg"
                            style="width: 100px; height: 100px;"></a>
                    <a href="#"><span class="white-text name">...</span></a>
                    <a href="#"><span class="white-text schoolName">...</span></a>
                </div>
            </li>
            <li data-tab="dashboard"><a href="#"><i class="material-icons">dashboard</i><span
                        data-lkey="sidebar.tab.dashboard">Dashboard</span></a></li>
            <li data-tab="calendar"><a href="#"><i class="material-icons">calendar_today</i><span
                        data-lkey="sidebar.tab.calendar">Calendar</span></a></li>
            <li data-tab="grades"><a href="#"><i class="material-icons">grade</i><span
                        data-lkey="sidebar.tab.grades">Grades</span></a></li>
            <li data-tab="messages"><a href="#"><i class="material-icons">message</i><span
                        data-lkey="sidebar.tab.messages">Messages</span></a></li>
            <li>
                <div class="divider"></div>
            </li>
            <li data-tab="personalization"><a href="#"><i class="material-icons">brush</i><span
                        data-lkey="sidebar.tab.personalization">Personalization</span></a></li>
            <li>
                <div class="divider"></div>
            </li>
            <div id="language-selector-sidebar" style="margin: 5px;"></div>
        </ul>
        <div class="tabs">
            <div class="tab tab-dashboard">
                D
            </div>
            <div class="tab tab-calendar">
                <ul id="calendarPicker" class="sidenav sidenav-fixed calendarPicker">
                    <li>
                        <i class="material-icons">calendar_today</i><span
                            data-lkey="calendar.datepicker.dates">Dates</span>
                        <br>
                        <span data-lkey="calendar.datepicker.from">From</span>: <input type="date" id="calendar-from">
                        <br>
                        <span data-lkey="calendar.datepicker.to">To</span>: <input type="date" id="calendar-to">
                    </li>
                </ul>
                <div class="appointments">

                </div>
            </div>
            <div class="tab tab-grades">
                G
            </div>
            <div class="tab tab-messages">
                M
            </div>
            <!-- PERSONALIZATION -->
            <div class="tab tab-personalization" style="display: inline-flex; text-transform: none;">
                <p data-lkey="personalization.themecolor">Theme Colour:</p>&nbsp;<div id="themeColorPicker"></div>
                <br>
            </div>
            <!-- PERSONALIZATION -->
        </div>
    </div>

    <div id="devTools" class="modal" style="display: none;">
        <div class="modal-content">
            <h4>Super Secret Devtools</h4><input type="checkbox" name="vehicle1" value="Bike">
            <p><label><input id="debugMode" type="checkbox" class="filled-in"
                        onchange="localStorage.setItem('debugMode',this.checked);debugMode = this.checked.toString();" /><span>Debug
                        Mode</span></label></p>
            <p><button class="waves-effect waves-light btn red" onclick="deleteAllCookies();"><i
                        class="material-icons left">delete_forever</i>Clear Cookies</button></p>
        </div>
    </div>

</body>
<script>
    if (localStorage.getItem('debugMode') == null) localStorage.setItem('debugMode', 'false');
    var debugMode = localStorage.getItem('debugMode');
    if (debugMode == 'true') $("#debugMode").attr('checked', 'checked');

    var currentTab = 'none';
    var loggedIn = false;
    var validSchools = {};
    var niceNames = {};

    var languagesFile = {};
    var language = 'en';

    var serverPublicKey = '';
    var privateKey = '';
    var publicKey = '';

    const materializeColors = { "#ffcdd2": "red lighten-4", "#ef9a9a": "red lighten-3", "#e57373": "red lighten-2", "#ef5350": "red lighten-1", "#f44336": "red", "#e53935": "red darken-1", "#d32f2f": "red darken-2", "#c62828": "red darken-3", "#b71c1c": "red darken-4", "#ff8a80": "red accent-1", "#ff5252": "red accent-2", "#ff1744": "red accent-3", "#d50000": "red accent-4", "#f8bbd0": "pink lighten-4", "#f48fb1": "pink lighten-3", "#f06292": "pink lighten-2", "#ec407a": "pink lighten-1", "#e91e63": "pink", "#d81b60": "pink darken-1", "#c2185b": "pink darken-2", "#ad1457": "pink darken-3", "#880e4f": "pink darken-4", "#ff80ab": "pink accent-1", "#ff4081": "pink accent-2", "#f50057": "pink accent-3", "#c51162": "pink accent-4", "#e1bee7": "purple lighten-4", "#ce93d8": "purple lighten-3", "#ba68c8": "purple lighten-2", "#ab47bc": "purple lighten-1", "#9c27b0": "purple", "#8e24aa": "purple darken-1", "#7b1fa2": "purple darken-2", "#6a1b9a": "purple darken-3", "#4a148c": "purple darken-4", "#ea80fc": "purple accent-1", "#e040fb": "purple accent-2", "#d500f9": "purple accent-3", "#aa00ff": "purple accent-4", "#d1c4e9": "deep-purple lighten-4", "#b39ddb": "deep-purple lighten-3", "#9575cd": "deep-purple lighten-2", "#7e57c2": "deep-purple lighten-1", "#673ab7": "deep-purple", "#5e35b1": "deep-purple darken-1", "#512da8": "deep-purple darken-2", "#4527a0": "deep-purple darken-3", "#311b92": "deep-purple darken-4", "#b388ff": "deep-purple accent-1", "#7c4dff": "deep-purple accent-2", "#651fff": "deep-purple accent-3", "#6200ea": "deep-purple accent-4", "#c5cae9": "indigo lighten-4", "#9fa8da": "indigo lighten-3", "#7986cb": "indigo lighten-2", "#5c6bc0": "indigo lighten-1", "#3f51b5": "indigo", "#3949ab": "indigo darken-1", "#303f9f": "indigo darken-2", "#283593": "indigo darken-3", "#1a237e": "indigo darken-4", "#8c9eff": "indigo accent-1", "#536dfe": "indigo accent-2", "#3d5afe": "indigo accent-3", "#304ffe": "indigo accent-4", "#bbdefb": "blue lighten-4", "#90caf9": "blue lighten-3", "#64b5f6": "blue lighten-2", "#42a5f5": "blue lighten-1", "#2196f3": "blue", "#1e88e5": "blue darken-1", "#1976d2": "blue darken-2", "#1565c0": "blue darken-3", "#0d47a1": "blue darken-4", "#82b1ff": "blue accent-1", "#448aff": "blue accent-2", "#2979ff": "blue accent-3", "#2962ff": "blue accent-4", "#b3e5fc": "light-blue lighten-4", "#81d4fa": "light-blue lighten-3", "#4fc3f7": "light-blue lighten-2", "#29b6f6": "light-blue lighten-1", "#03a9f4": "light-blue", "#039be5": "light-blue darken-1", "#0288d1": "light-blue darken-2", "#0277bd": "light-blue darken-3", "#01579b": "light-blue darken-4", "#80d8ff": "light-blue accent-1", "#40c4ff": "light-blue accent-2", "#00b0ff": "light-blue accent-3", "#0091ea": "light-blue accent-4", "#b2ebf2": "cyan lighten-4", "#80deea": "cyan lighten-3", "#4dd0e1": "cyan lighten-2", "#26c6da": "cyan lighten-1", "#00bcd4": "cyan", "#00acc1": "cyan darken-1", "#0097a7": "cyan darken-2", "#00838f": "cyan darken-3", "#006064": "cyan darken-4", "#84ffff": "cyan accent-1", "#18ffff": "cyan accent-2", "#00e5ff": "cyan accent-3", "#00b8d4": "cyan accent-4", "#b2dfdb": "teal lighten-4", "#80cbc4": "teal lighten-3", "#4db6ac": "teal lighten-2", "#26a69a": "teal lighten-1", "#009688": "teal", "#00897b": "teal darken-1", "#00796b": "teal darken-2", "#00695c": "teal darken-3", "#004d40": "teal darken-4", "#a7ffeb": "teal accent-1", "#64ffda": "teal accent-2", "#1de9b6": "teal accent-3", "#00bfa5": "teal accent-4", "#c8e6c9": "green lighten-4", "#a5d6a7": "green lighten-3", "#81c784": "green lighten-2", "#66bb6a": "green lighten-1", "#4caf50": "green", "#43a047": "green darken-1", "#388e3c": "green darken-2", "#2e7d32": "green darken-3", "#1b5e20": "green darken-4", "#b9f6ca": "green accent-1", "#69f0ae": "green accent-2", "#00e676": "green accent-3", "#00c853": "green accent-4", "#dcedc8": "light-green lighten-4", "#c5e1a5": "light-green lighten-3", "#aed581": "light-green lighten-2", "#9ccc65": "light-green lighten-1", "#8bc34a": "light-green", "#7cb342": "light-green darken-1", "#689f38": "light-green darken-2", "#558b2f": "light-green darken-3", "#33691e": "light-green darken-4", "#ccff90": "light-green accent-1", "#b2ff59": "light-green accent-2", "#76ff03": "light-green accent-3", "#64dd17": "light-green accent-4", "#f0f4c3": "lime lighten-4", "#e6ee9c": "lime lighten-3", "#dce775": "lime lighten-2", "#d4e157": "lime lighten-1", "#cddc39": "lime", "#c0ca33": "lime darken-1", "#afb42b": "lime darken-2", "#9e9d24": "lime darken-3", "#827717": "lime darken-4", "#f4ff81": "lime accent-1", "#eeff41": "lime accent-2", "#c6ff00": "lime accent-3", "#aeea00": "lime accent-4", "#fff9c4": "yellow lighten-4", "#fff59d": "yellow lighten-3", "#fff176": "yellow lighten-2", "#ffee58": "yellow lighten-1", "#ffeb3b": "yellow", "#fdd835": "yellow darken-1", "#fbc02d": "yellow darken-2", "#f9a825": "yellow darken-3", "#f57f17": "yellow darken-4", "#ffff8d": "yellow accent-1", "#ffff00": "yellow accent-2", "#ffea00": "yellow accent-3", "#ffd600": "yellow accent-4", "#ffecb3": "amber lighten-4", "#ffe082": "amber lighten-3", "#ffd54f": "amber lighten-2", "#ffca28": "amber lighten-1", "#ffc107": "amber", "#ffb300": "amber darken-1", "#ffa000": "amber darken-2", "#ff8f00": "amber darken-3", "#ff6f00": "amber darken-4", "#ffe57f": "amber accent-1", "#ffd740": "amber accent-2", "#ffc400": "amber accent-3", "#ffab00": "amber accent-4", "#ffe0b2": "orange lighten-4", "#ffcc80": "orange lighten-3", "#ffb74d": "orange lighten-2", "#ffa726": "orange lighten-1", "#ff9800": "orange", "#fb8c00": "orange darken-1", "#f57c00": "orange darken-2", "#ef6c00": "orange darken-3", "#e65100": "orange darken-4", "#ffd180": "orange accent-1", "#ffab40": "orange accent-2", "#ff9100": "orange accent-3", "#ff6d00": "orange accent-4", "#ffccbc": "deep-orange lighten-4", "#ffab91": "deep-orange lighten-3", "#ff8a65": "deep-orange lighten-2", "#ff7043": "deep-orange lighten-1", "#ff5722": "deep-orange", "#f4511e": "deep-orange darken-1", "#e64a19": "deep-orange darken-2", "#d84315": "deep-orange darken-3", "#bf360c": "deep-orange darken-4", "#ff9e80": "deep-orange accent-1", "#ff6e40": "deep-orange accent-2", "#ff3d00": "deep-orange accent-3", "#dd2c00": "deep-orange accent-4", "#d7ccc8": "brown lighten-4", "#bcaaa4": "brown lighten-3", "#a1887f": "brown lighten-2", "#8d6e63": "brown lighten-1", "#795548": "brown", "#6d4c41": "brown darken-1", "#5d4037": "brown darken-2", "#4e342e": "brown darken-3", "#3e2723": "brown darken-4", "#f5f5f5": "grey lighten-4", "#eeeeee": "grey lighten-3", "#e0e0e0": "grey lighten-2", "#bdbdbd": "grey lighten-1", "#9e9e9e": "grey", "#757575": "grey darken-1", "#616161": "grey darken-2", "#424242": "grey darken-3", "#212121": "grey darken-4", "#cfd8dc": "blue-grey lighten-4", "#b0bec5": "blue-grey lighten-3", "#90a4ae": "blue-grey lighten-2", "#78909c": "blue-grey lighten-1", "#607d8b": "blue-grey", "#546e7a": "blue-grey darken-1", "#455a64": "blue-grey darken-2", "#37474f": "blue-grey darken-3", "#263238": "blue-grey darken-4" };

    const defaultPalette = {
        "theme": "orange darken-3"
    };

    var palette;

    var pgpOptions = {
        userIds: [{ "name": makeRandomString(10), "email": makeRandomString(5) + "@" + makeRandomString(10) + ".com" }],
        numBits: 2048,
        passphrase: makeRandomString(20)
    };

    $(document).ready(function () {

        window.palette = JSON.parse(localStorage.getItem('palette')) || defaultPalette;
        localStorage.setItem('palette', JSON.stringify(palette));

        fixPalette();

        applyPersonalization();

        // Initialize all modals.
        $('.modal').modal();

        $('.backto-school').click(function(){
            $("#authentication").fadeOut(1000,function(){
                $("#enterSchoolName").fadeIn(1000);
            });
        });

        window.openpgp.initWorker({ path: '/js/openpgp.worker.js' });

        debug('Fetching language file...');
        $.get('/languages.json', function (data, err) {
            debug('Got language file!');
            languagesFile = data;
            var rawLang = navigator.language || navigator.userLanguage;

            if (localStorage.getItem("language") != null) {
                if (languagesFile.availableLanguages.indexOf(localStorage.getItem("language")) != -1) {
                    language = localStorage.getItem("language");
                } else {
                    if (languagesFile.availableLanguages.indexOf(navigator.language || navigator.userLanguage) == -1) language = 'en';
                    else language = navigator.language || navigator.userLanguage;
                }
            } else {
                if (languagesFile.availableLanguages.indexOf(navigator.language || navigator.userLanguage) == -1) language = 'en';
                else language = navigator.language || navigator.userLanguage;
            }

            if (languagesFile.languageAliases[rawLang]) {
                language = languagesFile.languageAliases[rawLang];
            }

            localStorage.setItem("language", language);

            setLocalizedValues();

            makeLanguagePicker('language-selector-schoolpicker');
            makeLanguagePicker('language-selector-auth');
            makeLanguagePicker('language-selector-sidebar');

            makeColorPicker('themeColorPicker', 'theme');

            openpgp.generateKey(pgpOptions).then(function (key) {
                window.privateKey = key.privateKeyArmored;
                window.publicKey = key.publicKeyArmored;

                console.log('Generated PGP keys.');
                connect();
                $("#encrypting").fadeOut(500);
            });
        });

        switchTab('dashboard');

        $('.menu').sidenav();
        $('.calendarPicker').sidenav({ edge: "right" });
        $('#schoolname').autocomplete({
            data: {},
            limit: 10,
            minLength: 1
        });

        $(".menu > li").click(function () {
            if (!$(this).data('tab')) return;
            switchTab($(this).data('tab'));
        });

        $('#schoolname').on('input', function () {
            window.socket.send(JSON.stringify({ "type": "getSchools", "content": $('#schoolname').val() }));
        });

        $('.proceedto-auth').click(function () {
            if (!$('.proceedto-auth').hasClass('disabled')) {
                $(".schoolName").text(niceNames[$("#schoolname").val().toLowerCase()]);
                $('#enterSchoolName').fadeOut(500, function () {
                    $("#authentication").fadeIn(500);
                });
            }
        });

        $('.proceedto-login').click(function () {
            if (!$('.proceedto-login').hasClass('disabled')) {
                var data = [validSchools[$("#schoolname").val().toLowerCase()], $("#username").val(), $("#password").val()];
                window.socket.encSend(JSON.stringify({ "type": "login", "content": JSON.stringify(data) }));
            }
        });


        $("#calendar-from").change(function () {
            updateCalendar();
        });

        $("#calendar-to").change(function () {
            updateCalendar();
        });
    });

    function connect() {
        var protocol = 'ws://';
        if (window.location.protocol == 'https:') {
            protocol = 'wss://';
        }
        debug('[SOCKET] Using ' + protocol + ' for websocket connection.');
        window.socket = new WebSocket(protocol + window.location.hostname + '/magister');

        window.socket.onerror, window.socket.onclose = function () {
            debug('[SOCKET] Lost connection to socket. Reconnecting in 1000ms.');
            $("#connecting").fadeIn(1000);
            setTimeout(connect, 1000);
        };

        window.socket.onopen = function () {
            debug('[SOCKET] Connected.');
            $("#connecting").fadeOut(1000);
        };

        window.socket.originalSend = window.socket.send;
        window.socket.send = function (message) {
            debug('[SOCKET] ⇧ ' + message);
            window.socket.originalSend(message);
        }

        window.socket.encSend = async function (message) {
            window.socket.send(await encrypt(message, serverPublicKey));
        }

        window.socket.onmessage = async function (event) {
            debug('[SOCKET] ⇩ ' + event.data);
            if (event.data.startsWith('-----BEGIN PGP PUBLIC KEY BLOCK-----')) {
                window.serverPublicKey = event.data;
                window.socket.send(publicKey);
                return;
            }

            var message = event.data

            try {
                message = await decrypt(message, privateKey);
            } catch (e) {
                debug('[SOCKET] [PGP] Failed to decrypt raw message. Maybe it is already decrypted?', 'warning');
            }

            try {
                var decoded = JSON.parse(message);
            } catch (e) {
                debug('[SOCKET] [JSON] Received invalid JSON message: ' + message, 'warning');
            }

            debug('[SOCKET] [JSON] Parsed JSON: ' + JSON.stringify(decoded));

            if (typeof (decoded.error) != 'undefined') {
                debug('[SOCKET] [ERROR] Got error: ' + decoded.error, 'error');
                if (decoded.error.startsWith('AuthError')) {
                    $("#wrongPassword").fadeIn(100);
                }
                return;
            }

            if (typeof (decoded.type) == 'undefined') return debug('[SOCKET] Received message without type.');
            if (typeof (decoded.content) == 'undefined') return debug('[SOCKET] Received message without content.');

            var type = decoded.type;
            var content = decoded.content;

            if (type == 'loginRequired') {
                if (loggedIn) window.location.reload();
                else $("#loginContainer").fadeIn(1000);
            } else if (type == 'serverInfo') {
                var info = JSON.parse(content);
            } else if (type == 'schools') {
                var schools = JSON.parse(content);
                if (schools.length != 0) {
                    schools.forEach(s => {
                        if (typeof (validSchools[s[0].toLowerCase()]) == 'undefined') {
                            validSchools[s[0].toLowerCase()] = s[1];
                            niceNames[s[0].toLowerCase()] = s[0];
                        }
                    });
                }
                var schoolList = {};
                schools.forEach(s => {
                    schoolList[s[0]] = null;
                });
                $('#schoolname').autocomplete({
                    data: schoolList,
                    limit: 10,
                    minLength: 1
                });
                $('#schoolname').trigger('updateData');
                M.Autocomplete.getInstance($('#schoolname')).open();
            } else if (type == 'fastlogin') {
                $(".schoolName").text(content);
            } else if (type == 'login_success') {
                resetCalendar();
                loggedIn = true;
                window.socket.send('{"type":"profileInfo","content":""}');
                $("#magister").show();
                $("#loginContainer").fadeOut(500);
                $(".login").fadeOut(500);

                // Set session.
                $.get('/set_session?schoolname=' + encodeURI($(".schoolName").first().text()) + '&session=' + encodeURI(content), function (data, err) {
                    console.info('Response when setting setting session token: ' + data);
                });
            } else if (type == 'profileInfo') {
                var info = JSON.parse(content);
                $(".name").text(info.name);
            } else if (type == 'appointments') {
                var appointments = JSON.parse(content);

                if (appointments.length == 0) {
                    $(".appointments").text('Geen afspraken gevonden.');
                } else {
                    $(".appointments").html('');
                    var date = new Date(0);
                    var newHTML = '<div class="row">';
                    var i = 0;
                    appointments.forEach(a => {
                        // Hide cancelled appointments.
                        if (a.isCancelled) return;
                        i++;

                        if (new Date(a.start).getDate() != date.getDate()) {
                            // New day!
                            if (i != 1) newHTML += '</div></div></div>';
                            date = new Date(a.start);
                            newHTML += '<div class="col s12 m7"><div class="card"><div class="card-image ' + palette.theme + '" data-pkey="theme"><img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="width: 0px; height: 100px;"><span class="card-title">' + languagesFile[language]['calendar.infocard.days'][date.getDay()] + ', ' + ([addZeroIfRequired(date.getDate()), addZeroIfRequired(date.getMonth() + 1), addZeroIfRequired(date.getFullYear())].join('-')) + '</span></div><div class="card-content">';
                        }

                        var hours = '';
                        if (a.startBySchoolhour != null) {
                            var list = [];
                            for (var i = a.startBySchoolhour; i <= a.endBySchoolhour; i++) {
                                list.push(i);
                            }
                            hours = '<span class="badge black left">' + list.join('-') + '</span>';
                        }

                        // Information has changed? Add changed badge
                        var extraHTML = '';
                        if (a.isChanged) extraHTML = '<span class="badge blue right" style="color: white;">!</span>';

                        // Show location if specified.
                        var location = '';
                        if (a.location) location = ' (' + a.location + ')';

                        newHTML += '<a href="#!" class="collection-item">';
                        newHTML += hours + a.description + location + extraHTML;
                        newHTML += '</a>';
                    });
                    $(".appointments").html(newHTML + '</div></div></div></div>');
                }
            } else if (type == 'profilePicture') {
                $(".profilePicture").attr('src', content);
            }
        }
    }

    function fixPalette() {
        Object.keys(window.palette).forEach(k => {
            if (typeof (window.palette[k]) == 'undefined') window.palette[k] = defaultPalette[k];
        });

        localStorage.setItem('palette', JSON.stringify(window.palette));
    }

    function applyPersonalization() {
        stripMaterializeColorClasses('[data-pkey]');

        var newColors = window.palette;

        Object.keys(newColors).forEach(pkey => {
            newColors[pkey].split(' ').forEach(color => {
                $("[data-pkey='" + pkey + "']").addClass(color);
            });
        });

        localStorage.setItem('palette', JSON.stringify(window.palette));
    }

    window.colorPickers = {};

    function makeColorPicker(id, valueToUpdate) {
        document.getElementById(id).addEventListener('changed', function (e) {
            if (new Date().getTime() < window.colorPickers[valueToUpdate].last + 2500) return;
            palette[valueToUpdate] = window.colorPickers[valueToUpdate].getSelectedValue();
            applyPersonalization();
        });

        window.colorPickers[valueToUpdate] = new IconSelect(id,
            {
                'selectedIconWidth': 23,
                'selectedIconHeight': 23,
                'selectedBoxPadding': 1,
                'iconsWidth': 48,
                'iconsHeight': 48,
                'boxIconSpace': 1,
                'vectoralIconNumber': 5,
                'horizontalIconNumber': 5
            });

        window.colorPickers[valueToUpdate].last = new Date().getTime();
        var icons = [];

        Object.keys(materializeColors).forEach(c => {
            icons.push({ 'iconFilePath': "data:image/svg+xml," + encodeURI("<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect id='backgroundrect' width='100%' height='100%' x='0' y='0' fill='" + c + "' stroke='none'/></svg>").replace('#', '%23'), 'iconValue': materializeColors[c] });
        });

        window.colorPickers[valueToUpdate].refresh(icons);

        var i = 0;
        Object.keys(materializeColors).forEach(c => {
            if (materializeColors[c] != palette[valueToUpdate]) return i++;
            window.colorPickers[valueToUpdate].setSelectedIndex(i);
        });
    }

    function switchTab(newTab) {
        if (newTab == currentTab) return;
        $(".tab").hide();
        $(".tab-" + newTab).fadeIn(500);
        $(".menu > li").removeClass('active');
        $("[data-tab=" + newTab + "]").addClass('active');
        currentTab = newTab;

        if (newTab == 'calendar') resetCalendar();
    }

    function addZeroIfRequired(number) {
        if (number < 10) return '0' + number;
        return number;
    }

    function resetCalendar() {
        var today = new Date();

        $("#calendar-from").val(today.getFullYear() + '-' + addZeroIfRequired(today.getMonth() + 1) + '-' + addZeroIfRequired(today.getDate()));

        var nextweek = new Date();
        nextweek.setDate(today.getDate() + 7);

        $("#calendar-to").val(nextweek.getFullYear() + '-' + addZeroIfRequired(nextweek.getMonth() + 1) + '-' + addZeroIfRequired(nextweek.getDate()));

        updateCalendar();
    }

    function updateCalendar() {
        var from = new Date($("#calendar-from").val());
        var to = new Date($("#calendar-to").val());
        var formattedFrom = addZeroIfRequired(from.getDate()) + '-' + addZeroIfRequired(from.getMonth() + 1) + '-' + from.getFullYear();
        var formattedTo = addZeroIfRequired(to.getDate()) + '-' + addZeroIfRequired(to.getMonth() + 1) + '-' + to.getFullYear();
        window.socket.send(JSON.stringify({ "type": "appointments", "content": JSON.stringify([formattedFrom, formattedTo]) }));
    }

    function setLocalizedValues() {
        $("[data-lkey]").each(function () {
            $(this).html(languagesFile[language][$(this).data('lkey')]);
        });
    }

    function deleteAllCookies() {
        var cookies = document.cookie.split(";");

        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i];
            var eqPos = cookie.indexOf("=");
            var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
        }

        window.location.reload();
    }

    function debug(message, type = 'info') {
        if (debugMode != 'true') return;
        if (type == 'info') console.log('%c[DEBUG] [INFO] ' + message, 'background: #0074D9; padding: 2px;');
        else if (type == 'warning') console.log('%c[DEBUG] [WARNING] ' + message, 'background: #FF851B; padding: 3px; color: black;');
        else if (type == 'error') console.log('%c[DEBUG] [ERROR] ' + message, 'background: #FF4136; padding: 4px; color: black;');
    }

    window.lPickers = {};
    window.globalChangeLPicker = false;

    function makeLanguagePicker(id) {
        document.getElementById(id).addEventListener('changed', function (e) {
            if (window.globalChangeLPicker) return;
            var values = window.lPickers[id].getSelectedValue().split(';');
            language = values[1];
            localStorage.setItem("language", language);

            setLocalizedValues();

            window.globalChangeLPicker = true;
            Object.keys(window.lPickers).forEach(pickerKey => {
                picker = window.lPickers[pickerKey];
                picker.setSelectedIndex(values[0]);
            });
            window.globalChangeLPicker = false;
        });

        window.lPickers[id] = new IconSelect(id,
            {
                'selectedIconWidth': 48,
                'selectedIconHeight': 48,
                'selectedBoxPadding': 1,
                'iconsWidth': 23,
                'iconsHeight': 23,
                'boxIconSpace': 1,
                'vectoralIconNumber': 4,
                'horizontalIconNumber': 4
            });
        var icons = [];

        var i = 0;

        icons.push({ 'iconFilePath': '/img/flag-' + language + '.svg', 'iconValue': i + ';' + language });

        languagesFile.availableLanguages.forEach(l => {
            if (l == language) return;
            i++;
            icons.push({ 'iconFilePath': '/img/flag-' + l + '.svg', 'iconValue': i + ';' + l });
        });

        window.lPickers[id].refresh(icons);

    }

    function stripMaterializeColorClasses(selector) {
        var classes = ['red', 'pink', 'purple', 'deep-purple', 'indigo', 'blue', 'light-blue', 'cyan', 'teal', 'green', 'light-green', 'lime', 'yellow', 'amber', 'orange', 'deep-orange', 'brown', 'grey', 'blue-grey', 'black', 'white', 'lighten-5', 'lighten-4', 'lighten-3', 'lighten-2', 'lighten-1', 'darken-1', 'darken-2', 'darken-3', 'darken-4', 'accent-1', 'accent-2', 'accent-3', 'accent-4'];
        classes.forEach(c => {
            $(selector).removeClass(c);
        });
    }

    function makeRandomString(length) {
        var result = '';
        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for (var i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

    async function encrypt(message, publickey) {
        const options = {
            message: openpgp.message.fromText(message),
            publicKeys: (await openpgp.key.readArmored(publickey)).keys
        }

        var ciphertext = await openpgp.encrypt(options);
        return ciphertext.data;
    }

    async function decrypt(message, privateKey) {
        const privKeyObj = (await openpgp.key.readArmored(privateKey.replace(/\r/, ''))).keys[0];
        await privKeyObj.decrypt(pgpOptions.passphrase);
        const options = {
            message: await openpgp.message.readArmored(message),
            privateKeys: [privKeyObj]
        }

        var ciphertext = await openpgp.decrypt(options);
        return ciphertext.data;
    }

    setInterval(function () {
        if (typeof (validSchools[$('#schoolname').val().toLowerCase()]) == 'undefined') {
            $('.proceedto-auth').addClass('disabled');
        } else {
            $('.proceedto-auth').removeClass('disabled');
        }
    }, 500);

    setInterval(function () {
        if ($("#username").val().length > 0 && $("#password").val().length) {
            $('.proceedto-login').removeClass('disabled');
        } else {
            $('.proceedto-login').addClass('disabled');
        }
    }, 500);

    setInterval(function () {
        $(".tab:not(.tab-" + currentTab + ")").hide();
    }, 500);

    // Super secret easter eggs and devtools, don't tell anyone!
    var eEgg = [];
    var eEggTrigger = ['arrowup', 'arrowup', 'arrowdown', 'arrowdown', 'arrowleft', 'arrowright', 'arrowleft', 'arrowright', 'b', 'a'];

    document.onkeydown = function (event) {
        var key = event.key.toLowerCase();
        if (eEgg.length == eEggTrigger.length) {
            if (key == 'd') {
                M.Modal.getInstance(document.getElementById("devTools")).open();
            }
            return eEgg = [];
        }
        if (eEggTrigger[eEgg.length] != key) return eEgg = [];
        eEgg.push(key);
    }
</script>
<style>
    /* CSS OVERRIDES */

    .tabs,
    .tab {
        overflow-x: visible !important;
        overflow-y: visible !important;
        text-align: left !important;
    }

    .icon-select .box {
        overflow: scroll !important;
    }

    @media only screen and (min-width: 993px) {
        .tabs {
            left: 150px;
        }
    }
</style>

</html>