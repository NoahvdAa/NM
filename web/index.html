<!DOCTYPE html>
<html>

<head>
    <!-- Import Google Icon Font -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Import Materialize CSS -->
    <link type="text/css" rel="stylesheet" href="css/materialize.css" media="screen,projection" />

    <!-- Let browser know website is optimized for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Required JS Libraries -->
    <script type="text/javascript" src="js/jquery-3.4.0.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="manifest" href="/icons/site.webmanifest">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#f06c00">
    <link rel="shortcut icon" href="/icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#f06c00">
    <meta name="msapplication-config" content="/icons/browserconfig.xml">
    <meta name="theme-color" content="#f06c00">

    <!-- IOS meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- IconSelect -->
    <link rel="stylesheet" type="text/css" href="/css/iconselect.css">
    <script type="text/javascript" src="/js/iconselect.min.js"></script>
    <script type="text/javascript" src="/js/iscroll.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">

    <!-- OpenPGP.js for encryption -->
    <script src="/js/openpgp.min.js"></script>

    <title>NM</title>
</head>

<body>

    <div id="encrypting"
        style="background-color: #ef6c00; background-image: url(/img/loading.svg) center no-repeat; background-size: 12.5%; left: 0; right: 0; top: 0; bottom: 0; position: fixed; z-index: 9999; text-align: center; font-size: 50px; color: white;">
        <p data-lkey="login.encrypting">Encrypting connection...</p>
    </div>

    <div id="connecting"
        style="background-color: #ef6c00; background-image: url(/img/loading.svg) center no-repeat; background-size: 12.5%; left: 0; right: 0; top: 0; bottom: 0; position: fixed; z-index: 9999; display: none;">
        &nbsp;
    </div>

    <noscript style="background: white; z-index: 99999; left: 0; right: 0; top: 0; bottom: 0; position: fixed;">
        Enable JavaScript to use NM.
        <br>
        Schakel JavaScript in om NM te kunnen gebruiken.
    </noscript>

    <div class="login"
        style="background-color: #ef6c00; left: 0; right: 0; top: 0; bottom: 0; position: fixed; z-index: 999;">
        <div class="container">
            &nbsp;
        </div>
        <div class="container" id="loginContainer" style="display: none;">
            <div class="card" id="enterSchoolName">
                <div class="card-image">
                    <a class="btn-floating halfway-fab waves-effect waves-light red disabled proceedto-auth"><i
                            class="material-icons">arrow_forward</i></a>
                </div>
                <div class="card-content">
                    <p data-lkey="login.schoolpicker.welcome">Welcome to NM. Choose your school.</p>
                    <div class="input-field">
                        <i class="material-icons prefix">school</i>
                        <input placeholder="" id="schoolname" type="text" class="autocomplete" data-lpignore="true">
                    </div>
                    <br>
                    <p data-lkey="login.schoolpicker.opensource">NM is open source! Click <a
                            href="https://github.com/NoahvdAa/NM" target="_blank">here</a> to see
                        our GitHub repository.</p>
                    <br>
                    <p><img src="/img/lock.svg" width="25px;">&nbsp;<span data-lkey="login.security.encrypted"></span>
                    </p>
                    <br>
                    <div id="language-selector-schoolpicker"></div>
                </div>
            </div>
            <div class="card" id="authentication" style="display: none;">
                <div class="card-image">
                    <a class="btn-floating halfway-fab waves-effect waves-light red disabled proceedto-login"><i
                            class="material-icons">arrow_forward</i></a>
                </div>
                <div class="card-content">
                    <p id="schoolName"></p>
                    <br>
                    <div class="input-field">
                        <i class="material-icons prefix">person</i>
                        <input placeholder="" id="username" type="text">
                        <label data-lkey="login.auth.username">Username</label>
                    </div>
                    <div class="input-field">
                        <i class="material-icons prefix">lock</i>
                        <input placeholder="" id="password" type="password">
                        <label data-lkey="login.auth.password">Password</label>
                    </div>
                    <div class="row" id="wrongPassword" style="display: none;">
                        <div class="col">
                            <div class="card-panel red">
                                <span class="white-text" data-lkey="login.auth.wrongpassword">
                                    De combinatie van deze gebruikersnaam en dit wachtwoord klopt niet.
                                </span>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div id="language-selector-auth"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container" id="magister" style="display: none;">
        <a href="#" data-target="nav" class="btn-floating red sidenav-trigger hide-on-large-only"><i
                class="material-icons">menu</i></a>
        <a href="#" data-target="calendarPicker"
            class="tab tab-calendar btn-floating blue lighten-2 sidenav-trigger hide-on-large-only"><i
                class="material-icons">date_range</i></a>
        <ul id="nav" class="sidenav sidenav-fixed menu">
            <li>
                <div class="user-view">
                    <div class="background orange darken-3"></div>
                    <a href="#"><img class="circle profilePicture" src="/img/loading.svg"
                            style="width: 100px; height: 100px;"></a>
                    <a href="#"><span class="white-text name">...</span></a>
                    <a href="#"><span class="white-text schoolName">...</span></a>
                </div>
            </li>
            <li data-tab="dashboard"><a href="#"><i class="material-icons">dashboard</i><span
                        data-lkey="sidebar.tab.dashboard">Dashboard</span></a></li>
            <li data-tab="calendar"><a href="#"><i class="material-icons">calendar_today</i><span
                        data-lkey="sidebar.tab.calendar">Calendar</span></a></li>
            <li data-tab="grades"><a href="#"><i class="material-icons">grade</i><span
                        data-lkey="sidebar.tab.grades">Grades</span></a></li>
            <li data-tab="messages"><a href="#"><i class="material-icons">message</i><span
                        data-lkey="sidebar.tab.messages">Messages</span></a></li>
            <li>
                <div class="divider"></div>
            </li>
            <li data-tab="personalization"><a href="#"><i class="material-icons">brush</i><span
                        data-lkey="sidebar.tab.personalization">Personalization</span></a></li>
            <li>
                <div class="divider"></div>
            </li>
            <div id="language-selector-sidebar" style="margin: 5px;"></div>
        </ul>
        <div class="tabs">
            <div class="tab tab-dashboard">
                D
            </div>
            <div class="tab tab-calendar">
                <ul id="calendarPicker" class="sidenav sidenav-fixed calendarPicker">
                    <li>
                        <i class="material-icons">calendar_today</i><span
                            data-lkey="calendar.datepicker.dates">Dates</span>
                        <br>
                        <span data-lkey="calendar.datepicker.from">From</span>: <input type="date" id="calendar-from">
                        <br>
                        <span data-lkey="calendar.datepicker.to">To</span>: <input type="date" id="calendar-to">
                    </li>
                </ul>
                <div class="appointments">

                </div>
            </div>
            <div class="tab tab-grades">
                G
            </div>
            <div class="tab tab-messages">
                M
            </div>
            <!-- PERSONALIZATION -->
            <div class="tab tab-personalization">
                P
            </div>
            <!-- PERSONALIZATION -->
        </div>
    </div>

    <div id="devTools" class="modal" style="display: none;">
        <div class="modal-content">
            <h4>Super Secret Devtools</h4><input type="checkbox" name="vehicle1" value="Bike">
            <p><label><input id="debugMode" type="checkbox" class="filled-in"
                        onchange="localStorage.setItem('debugMode',this.checked);debugMode = this.checked.toString();" /><span>Debug
                        Mode</span></label></p>
            <p><button class="waves-effect waves-light btn red" onclick="deleteAllCookies();"><i
                        class="material-icons left">delete_forever</i>Clear Cookies</button></p>
        </div>
    </div>

</body>
<script>
    if (localStorage.getItem('debugMode') == null) localStorage.setItem('debugMode', 'false');
    var debugMode = localStorage.getItem('debugMode');
    if (debugMode == 'true') $("#debugMode").attr('checked', 'checked');

    var currentTab = 'none';
    var loggedIn = false;
    var validSchools = {};
    var niceNames = {};

    var languagesFile = {};
    var language = 'en';

    var serverPublicKey = '';
    var privateKey = '';
    var publicKey = '';

    var pgpOptions = {
        userIds: [{ "name": makeRandomString(10), "email": makeRandomString(5) + "@" + makeRandomString(10) + ".com" }],
        numBits: 2048,
        passphrase: makeRandomString(20)
    };

    $(document).ready(function () {

        // Initialize all modals.
        $('.modal').modal();

        window.openpgp.initWorker({ path: '/js/openpgp.worker.js' });

        debug('Fetching language file...');
        $.get('/languages.json', function (data, err) {
            debug('Got language file!');
            languagesFile = data;

            if (localStorage.getItem("language") != null) {
                if (languagesFile.availableLanguages.indexOf(localStorage.getItem("language")) != -1) {
                    language = localStorage.getItem("language");
                } else {
                    if (languagesFile.availableLanguages.indexOf(navigator.language || navigator.userLanguage) == -1) language = 'en';
                    else language = navigator.language || navigator.userLanguage;
                }
            } else {
                if (languagesFile.availableLanguages.indexOf(navigator.language || navigator.userLanguage) == -1) language = 'en';
                else language = navigator.language || navigator.userLanguage;
            }

            localStorage.setItem("language", language);

            setLocalizedValues();

            makeLanguagePicker('language-selector-schoolpicker');
            makeLanguagePicker('language-selector-auth');
            makeLanguagePicker('language-selector-sidebar');

            openpgp.generateKey(pgpOptions).then(function (key) {
                window.privateKey = key.privateKeyArmored;
                window.publicKey = key.publicKeyArmored;

                console.log('Generated PGP keys.');
                connect();
                $("#encrypting").fadeOut(500);
            });
        });

        switchTab('dashboard');

        $('.menu').sidenav();
        $('.calendarPicker').sidenav({ edge: "right" });
        $('#schoolname').autocomplete({
            data: {},
            limit: 10,
            minLength: 1
        });

        $(".menu > li").click(function () {
            if (!$(this).data('tab')) return;
            switchTab($(this).data('tab'));
        });

        $('#schoolname').on('input', function () {
            window.socket.send(JSON.stringify({ "type": "getSchools", "content": $('#schoolname').val() }));
        });

        $('.proceedto-auth').click(function () {
            if (!$('.proceedto-auth').hasClass('disabled')) {
                $(".schoolName").text(niceNames[$("#schoolname").val().toLowerCase()]);
                $('#enterSchoolName').fadeOut(500, function () {
                    $("#authentication").fadeIn(500);
                });
            }
        });

        $('.proceedto-login').click(function () {
            if (!$('.proceedto-login').hasClass('disabled')) {
                var data = [validSchools[$("#schoolname").val().toLowerCase()], $("#username").val(), $("#password").val()];
                window.socket.encSend(JSON.stringify({ "type": "login", "content": JSON.stringify(data) }));
            }
        });


        $("#calendar-from").change(function () {
            updateCalendar();
        });

        $("#calendar-to").change(function () {
            updateCalendar();
        });
    });

    function connect() {
        var protocol = 'ws://';
        if (window.location.protocol == 'https:') {
            protocol = 'wss://';
        }
        debug('[SOCKET] Using ' + protocol + ' for websocket connection.');
        window.socket = new WebSocket(protocol + window.location.hostname + '/magister');

        window.socket.onerror, window.socket.onclose = function () {
            debug('[SOCKET] Lost connection to socket. Reconnecting in 1000ms.');
            $("#connecting").fadeIn(1000);
            setTimeout(connect, 1000);
        };

        window.socket.onopen = function () {
            debug('[SOCKET] Connected.');
            $("#connecting").fadeOut(1000);
        };

        window.socket.originalSend = window.socket.send;
        window.socket.send = function (message) {
            debug('[SOCKET] ⇧ ' + message);
            window.socket.originalSend(message);
        }

        window.socket.encSend = async function (message) {
            window.socket.send(await encrypt(message, serverPublicKey));
        }

        window.socket.onmessage = async function (event) {
            debug('[SOCKET] ⇩ ' + event.data);
            if (event.data.startsWith('-----BEGIN PGP PUBLIC KEY BLOCK-----')) {
                window.serverPublicKey = event.data;
                window.socket.send(publicKey);
                return;
            }

            var message = event.data

            try {
                message = await decrypt(message, privateKey);
            } catch (e) {
                debug('[SOCKET] [PGP] Failed to decrypt raw message. Maybe it is already decrypted?', 'warning');
            }

            try {
                var decoded = JSON.parse(message);
            } catch (e) {
                debug('[SOCKET] [JSON] Received invalid JSON message: ' + message, 'warning');
            }

            debug('[SOCKET] [JSON] Parsed JSON: ' + JSON.stringify(decoded));

            if (typeof (decoded.error) != 'undefined') {
                debug('[SOCKET] [ERROR] Got error: ' + decoded.error, 'error');
                if (decoded.error.startsWith('AuthError')) {
                    $("#wrongPassword").fadeIn(100);
                }
                return;
            }

            if (typeof (decoded.type) == 'undefined') return debug('[SOCKET] Received message without type.');
            if (typeof (decoded.content) == 'undefined') return debug('[SOCKET] Received message without content.');

            var type = decoded.type;
            var content = decoded.content;

            if (type == 'loginRequired') {
                if (loggedIn) window.location.reload();
                else $("#loginContainer").fadeIn(1000);
            } else if (type == 'serverInfo') {
                var info = JSON.parse(content);
            } else if (type == 'schools') {
                var schools = JSON.parse(content);
                if (schools.length != 0) {
                    schools.forEach(s => {
                        if (typeof (validSchools[s[0].toLowerCase()]) == 'undefined') {
                            validSchools[s[0].toLowerCase()] = s[1];
                            niceNames[s[0].toLowerCase()] = s[0];
                        }
                    });
                }
                var schoolList = {};
                schools.forEach(s => {
                    schoolList[s[0]] = null;
                });
                $('#schoolname').autocomplete({
                    data: schoolList,
                    limit: 10,
                    minLength: 1
                });
                $('#schoolname').trigger('updateData');
                M.Autocomplete.getInstance($('#schoolname')).open();
            } else if (type == 'fastlogin') {
                $(".schoolName").text(content);
            } else if (type == 'login_success') {
                resetCalendar();
                loggedIn = true;
                window.socket.send('{"type":"profileInfo","content":""}');
                $("#magister").show();
                $("#loginContainer").fadeOut(500);
                $(".login").fadeOut(500);

                // Set session.
                $.get('/set_session?schoolname=' + encodeURI($(".schoolName").first().text()) + '&session=' + encodeURI(content), function (data, err) {
                    console.info('Response when setting setting session token: ' + data);
                });
            } else if (type == 'profileInfo') {
                var info = JSON.parse(content);
                $(".name").text(info.name);
            } else if (type == 'appointments') {
                var appointments = JSON.parse(content);

                if (appointments.length == 0) {
                    $(".appointments").text('Geen afspraken gevonden.');
                } else {
                    $(".appointments").html('');
                    var date = new Date(0);
                    var newHTML = $(".appointments").html();
                    appointments.forEach(a => {
                        // Hide cancelled appointments.
                        if (a.isCancelled) return;

                        if (new Date(a.start).getDate() != date.getDate()) {
                            // New day!
                            newHTML += '</div>';
                            date = new Date(a.start);
                            newHTML += '<div class="collection"><a class="collection-item"><strong>' + ([addZeroIfRequired(date.getDate()), addZeroIfRequired(date.getMonth() + 1), addZeroIfRequired(date.getFullYear())].join('-')) + '</strong></a>';
                        }

                        var hours = '';
                        if (a.startBySchoolhour != null) {
                            var list = [];
                            for (var i = a.startBySchoolhour; i <= a.endBySchoolhour; i++) {
                                list.push(i);
                            }
                            hours = '<span class="badge black">' + list.join('-') + '</span>';
                        }

                        // Information has changed? Make it blue.
                        var extraClasses = '';
                        if (a.isChanged) extraClasses = ' blue lighten-3';

                        // Show location if specified.
                        var location = '';
                        if (a.location) location = ' (' + a.location + ')';

                        newHTML += '<a href="#!" class="collection-item' + extraClasses + '">';
                        newHTML += hours + a.description + location;
                        newHTML += '</a>';
                    });
                    $(".appointments").html(newHTML + '</div>');
                }
            } else if (type == 'profilePicture') {
                $(".profilePicture").attr('src', content);
            }
        }
    }

    function switchTab(newTab) {
        if (newTab == currentTab) return;
        $(".tab").hide();
        $(".tab-" + newTab).fadeIn(500);
        $(".menu > li").removeClass('active');
        $("[data-tab=" + newTab + "]").addClass('active');
        currentTab = newTab;

        if (newTab == 'calendar') resetCalendar();
    }

    function addZeroIfRequired(number) {
        if (number < 10) return '0' + number;
        return number;
    }

    function resetCalendar() {
        var today = new Date();

        $("#calendar-from").val(today.getFullYear() + '-' + addZeroIfRequired(today.getMonth() + 1) + '-' + addZeroIfRequired(today.getDate()));

        var nextweek = new Date();
        nextweek.setDate(today.getDate() + 7);

        $("#calendar-to").val(nextweek.getFullYear() + '-' + addZeroIfRequired(nextweek.getMonth() + 1) + '-' + addZeroIfRequired(nextweek.getDate()));

        updateCalendar();
    }

    function updateCalendar() {
        var from = new Date($("#calendar-from").val());
        var to = new Date($("#calendar-to").val());
        var formattedFrom = addZeroIfRequired(from.getDate()) + '-' + addZeroIfRequired(from.getMonth() + 1) + '-' + from.getFullYear();
        var formattedTo = addZeroIfRequired(to.getDate()) + '-' + addZeroIfRequired(to.getMonth() + 1) + '-' + to.getFullYear();
        window.socket.send(JSON.stringify({ "type": "appointments", "content": JSON.stringify([formattedFrom, formattedTo]) }));
    }

    function setLocalizedValues() {
        $("[data-lkey]").each(function () {
            $(this).html(languagesFile[language][$(this).data('lkey')]);
        });
    }

    function deleteAllCookies() {
        var cookies = document.cookie.split(";");

        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i];
            var eqPos = cookie.indexOf("=");
            var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
        }

        window.location.reload();
    }

    function debug(message, type = 'info') {
        if (debugMode != 'true') return;
        if (type == 'info') console.log('%c[DEBUG] [INFO] ' + message, 'background: #0074D9; padding: 2px;');
        else if (type == 'warning') console.log('%c[DEBUG] [WARNING] ' + message, 'background: #FF851B; padding: 3px; color: black;');
        else if (type == 'error') console.log('%c[DEBUG] [ERROR] ' + message, 'background: #FF4136; padding: 4px; color: black;');
    }

    window.lPickers = {};
    window.globalChangeLPicker = false;

    function makeLanguagePicker(id) {
        document.getElementById(id).addEventListener('changed', function (e) {
            if (window.globalChangeLPicker) return;
            var values = window.lPickers[id].getSelectedValue().split(';');
            language = values[1];
            localStorage.setItem("language", language);

            setLocalizedValues();

            window.globalChangeLPicker = true;
            Object.keys(window.lPickers).forEach(pickerKey => {
                picker = window.lPickers[pickerKey];
                picker.setSelectedIndex(values[0]);
            });
            window.globalChangeLPicker = false;
        });

        window.lPickers[id] = new IconSelect(id,
            {
                'selectedIconWidth': 48,
                'selectedIconHeight': 48,
                'selectedBoxPadding': 1,
                'iconsWidth': 23,
                'iconsHeight': 23,
                'boxIconSpace': 1,
                'vectoralIconNumber': 4,
                'horizontalIconNumber': 4
            });
        var icons = [];

        var i = 0;

        icons.push({ 'iconFilePath': '/img/flag-' + language + '.svg', 'iconValue': i + ';' + language });

        languagesFile.availableLanguages.forEach(l => {
            if (l == language) return;
            i++;
            icons.push({ 'iconFilePath': '/img/flag-' + l + '.svg', 'iconValue': i + ';' + l });
        });

        window.lPickers[id].refresh(icons);

    }

    function stripMaterializeColorClasses(selector) {
        var classes = ['red', 'pink', 'purple', 'deep-purple', 'indigo', 'blue', 'light-blue', 'cyan', 'teal', 'green', 'light-green', 'lime', 'yellow', 'amber', 'orange', 'deep-orange', 'brown', 'grey', 'blue-grey', 'black', 'white', 'lighten-5', 'lighten-4', 'lighten-3', 'lighten-2', 'lighten-1', 'darken-1', 'darken-2', 'darken-3', 'darken-4', 'accent-1', 'accent-2', 'accent-3', 'accent-4'];
        classes.forEach(c=>{
            $(selector).removeClass(c);
        });
    }

    function makeRandomString(length) {
        var result = '';
        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for (var i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

    async function encrypt(message, publickey) {
        const options = {
            message: openpgp.message.fromText(message),
            publicKeys: (await openpgp.key.readArmored(publickey)).keys
        }

        var ciphertext = await openpgp.encrypt(options);
        return ciphertext.data;
    }

    async function decrypt(message, privateKey) {
        const privKeyObj = (await openpgp.key.readArmored(privateKey.replace(/\r/, ''))).keys[0];
        await privKeyObj.decrypt(pgpOptions.passphrase);
        const options = {
            message: await openpgp.message.readArmored(message),
            privateKeys: [privKeyObj]
        }

        var ciphertext = await openpgp.decrypt(options);
        return ciphertext.data;
    }

    setInterval(function () {
        if (typeof (validSchools[$('#schoolname').val().toLowerCase()]) == 'undefined') {
            $('.proceedto-auth').addClass('disabled');
        } else {
            $('.proceedto-auth').removeClass('disabled');
        }
    }, 500);

    setInterval(function () {
        if ($("#username").val().length > 0 && $("#password").val().length) {
            $('.proceedto-login').removeClass('disabled');
        } else {
            $('.proceedto-login').addClass('disabled');
        }
    }, 500);

    setInterval(function () {
        $(".tab:not(.tab-" + currentTab + ")").hide();
    }, 500);

    // Super secret easter eggs and devtools, don't tell anyone!
    var eEgg = [];
    var eEggTrigger = ['arrowup', 'arrowup', 'arrowdown', 'arrowdown', 'arrowleft', 'arrowright', 'arrowleft', 'arrowright', 'b', 'a'];

    document.onkeydown = function (event) {
        var key = event.key.toLowerCase();
        if (eEgg.length == eEggTrigger.length) {
            if (key == 'd') {
                M.Modal.getInstance(document.getElementById("devTools")).open();
            }
            return eEgg = [];
        }
        if (eEggTrigger[eEgg.length] != key) return eEgg = [];
        eEgg.push(key);
    }
</script>
<style>
    /* CSS OVERRIDES */

    .tabs,
    .tab {
        overflow-x: visible !important;
        overflow-y: visible !important;
        text-align: left !important;
    }

    @media only screen and (min-width: 993px) {
        .tabs {
            left: 150px;
        }
    }
</style>

</html>