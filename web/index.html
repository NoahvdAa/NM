<!DOCTYPE html>
<html>

<head>
    <!-- Import Google Icon Font -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Import Materialize CSS -->
    <link type="text/css" rel="stylesheet" href="css/materialize.css" media="screen,projection" />

    <!-- Let browser know website is optimized for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Required JS Libraries -->
    <script type="text/javascript" src="js/jquery-3.4.0.js"></script>
    <script type="text/javascript" src="js/materialize.js"></script>

    <title>NM</title>
</head>

<body>

    <div id="connecting"
        style="background-color: #ef6c00; background-image: url(/img/loading.svg) center no-repeat; background-size: 12.5%; left: 0; right: 0; top: 0; bottom: 0; position: fixed; z-index: 999;">
        &nbsp;
    </div>

    <noscript style="background: white; z-index: 99999; left: 0; right: 0; top: 0; bottom: 0; position: fixed;">
        Enable JavaScript to use NM.
        <br>
        Schakel JavaScript in om NM te kunnen gebruiken.
    </noscript>

    <div class="login"
        style="background-color: #ef6c00; left: 0; right: 0; top: 0; bottom: 0; position: fixed; z-index: 999;">
        <div class="container">
            &nbsp;
        </div>
        <div class="container" id="loginContainer" style="display: none;">
            <div class="card" id="enterSchoolName">
                <div class="card-image">
                    <a class="btn-floating halfway-fab waves-effect waves-light red disabled proceedto-auth"><i
                            class="material-icons">arrow_forward</i></a>
                </div>
                <div class="card-content">
                    <p>Welkom bij NM. Kies je school.</p>
                    <div class="input-field">
                        <i class="material-icons prefix">school</i>
                        <input placeholder="bijvoorbeeld Terra College" id="schoolname" type="text" class="autocomplete"
                            data-lpignore="true">
                    </div>
                    <br>
                    <p>NM is open source! Click <a href="https://github.com/NoahvdAa/NM" target="_blank">here</a> to see
                        our GitHub repository.</p>
                </div>
            </div>
            <div class="card" id="authentication" style="display: none;">
                <div class="card-image">
                    <a class="btn-floating halfway-fab waves-effect waves-light red disabled proceedto-login"><i
                            class="material-icons">arrow_forward</i></a>
                </div>
                <div class="card-content">
                    <p id="schoolName"></p>
                    <br>
                    <div class="input-field">
                        <i class="material-icons prefix">person</i>
                        <input placeholder="" id="username" type="text">
                        <label>Gebruikersnaam</label>
                    </div>
                    <div class="input-field">
                        <i class="material-icons prefix">lock</i>
                        <input placeholder="" id="password" type="password">
                        <label>Wachtwoord</label>
                    </div>
                    <div class="row" id="wrongPassword" style="display: none;">
                        <div class="col">
                            <div class="card-panel red">
                                <span class="white-text">
                                    De combinatie van deze gebruikersnaam en dit wachtwoord klopt niet.
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container" id="magister" style="display: none;">
        <a href="#" data-target="nav" class="btn-floating red sidenav-trigger hide-on-large-only"><i
                class="material-icons">menu</i></a>
        <a href="#" data-target="calendarPicker"
            class="tab tab-calendar btn-floating blue lighten-2 sidenav-trigger hide-on-large-only"><i
                class="material-icons">date_range</i></a>
        <ul id="nav" class="sidenav sidenav-fixed menu">
            <li>
                <div class="user-view">
                    <div class="background orange darken-3"></div>
                    <a href="#"><img class="circle" src="/img/loading.svg" style="width: 100px; height: 100px;"></a>
                    <a href="#"><span class="white-text name">...</span></a>
                    <a href="#"><span class="white-text schoolName">...</span></a>
                </div>
            </li>
            <li data-tab="dashboard"><a href="#"><i class="material-icons">dashboard</i>Dashboard</a></li>
            <li data-tab="calendar"><a href="#"><i class="material-icons">calendar_today</i>Agenda</a></li>
            <li data-tab="grades"><a href="#"><i class="material-icons">grade</i>Cijfers</a></li>
            <li>
                <div class="divider"></div>
            </li>
            <li data-tab="personalization"><a href="#"><i class="material-icons">brush</i>Personalisatie</a></li>
        </ul>
        <div class="tabs" style="left: 150px;">
            <div class="tab tab-dashboard">
                D
            </div>
            <div class="tab tab-calendar">
                <ul id="calendarPicker" class="sidenav sidenav-fixed calendarPicker">
                    <li>
                        <div class="user-view">
                            <div class="background orange darken-3"></div>
                        </div>
                    </li>
                    <li><a href="#"><i class="material-icons">dashboard</i>Buttons</a></li>
                    <li>
                        <div class="divider"></div>
                    </li>
                    <li><a class="waves-effect" href="#!">Third Link With Waves</a></li>
                </ul>
            </div>
            <div class="tab tab-grades">
                G
            </div>
            <!-- PERSONALIZATION -->
            <div class="tab tab-personalization">
                P
            </div>
            <!-- PERSONALIZATION -->
        </div>
    </div>

</body>
<script>
    var currentTab = 'none';
    var loggedIn = false;
    var validSchools = {};
    var niceNames = {};

    $(document).ready(function () {
        switchTab('dashboard');

        $('.menu').sidenav();
        $('.calendarPicker').sidenav({ edge: "right" });
        $('#schoolname').autocomplete({
            data: {},
            limit: 10,
            minLength: 1
        });

        connect();

        $(".menu > li").click(function () {
            if (!$(this).data('tab')) return;
            switchTab($(this).data('tab'));
        });

        $('#schoolname').on('input', function () {
            window.socket.send(JSON.stringify({ "type": "getSchools", "content": $('#schoolname').val() }));
        });

        $('.proceedto-auth').click(function () {
            if (!$('.proceedto-auth').hasClass('disabled')) {
                $(".schoolName").text(niceNames[$("#schoolname").val().toLowerCase()]);
                $('#enterSchoolName').fadeOut(500, function () {
                    $("#authentication").fadeIn(500);
                });
            }
        });

        $('.proceedto-login').click(function () {
            if (!$('.proceedto-login').hasClass('disabled')) {
                var data = [validSchools[$("#schoolname").val().toLowerCase()], $("#username").val(), $("#password").val()];
                window.socket.send(JSON.stringify({ "type": "login", "content": JSON.stringify(data) }));
            }
        });
    });

    function connect() {
        var protocol = 'ws://';
        if (window.location.protocol == 'https:') {
            protocol = 'wss://';
        }
        window.socket = new WebSocket(protocol + window.location.hostname + '/magister');

        window.socket.onerror, window.socket.onclose = function () {
            $("#connecting").fadeIn(1000);
            setTimeout(connect, 1000);
        };

        window.socket.onopen = function () {
            $("#connecting").fadeOut(1000);
        };

        window.socket.onmessage = function (event) {
            var message = event.data;
            try {
                var decoded = JSON.parse(message);
            } catch (e) {
                return console.error('INVALID JSON RECEIVED: ' + message);
            }

            if (typeof (decoded.error) != 'undefined') {
                if (decoded.error.startsWith('AuthError')) {
                    $("#wrongPassword").fadeIn(100);
                }
            }

            if (typeof (decoded.type) == 'undefined') return console.warn('No type found. Ignoring message.');
            if (typeof (decoded.content) == 'undefined') return console.warn('No content found. Ignoring message.');

            var type = decoded.type;
            var content = decoded.content;

            if (type == 'loginRequired') {
                if (loggedIn) window.location.reload();
                else $("#loginContainer").fadeIn(1000);
            } else if (type == 'schools') {
                var schools = JSON.parse(content);
                if (schools.length != 0) {
                    schools.forEach(s => {
                        if (typeof (validSchools[s[0].toLowerCase()]) == 'undefined') {
                            validSchools[s[0].toLowerCase()] = s[1];
                            niceNames[s[0].toLowerCase()] = s[0];
                        }
                    });
                }
                setTimeout(function () {
                    var schoolList = {};
                    schools.forEach(s => {
                        schoolList[s[0]] = null;
                    });
                    $('#schoolname').autocomplete({
                        data: schoolList,
                        limit: 10,
                        minLength: 1
                    });
                    $('#schoolname').trigger('updateData');
                }, 100);
            } else if (type == 'fastlogin') {
                $(".schoolName").text(content);
            } else if (type == 'login_success') {
                loggedIn = true;
                window.socket.send('{"type":"profileInfo","content":""}');
                $("#magister").show();
                $("#loginContainer").fadeOut(500);
                $(".login").fadeOut(500);

                // Set session.
                $.get('/set_session?schoolname=' + encodeURI($(".schoolName").first().text()) + '&session=' + encodeURI(content), function (data, err) {
                    console.info('Response when setting setting session token: ' + data);
                });
            } else if (type == 'profileInfo') {
                var info = JSON.parse(content);
                $(".name").text(info.name);
            }
        }
    }

    function switchTab(newTab) {
        if (newTab == currentTab) return;
        $(".tab").hide();
        $(".tab-" + newTab).fadeIn(500);
        $(".menu > li").removeClass('active');
        $("[data-tab=" + newTab + "]").addClass('active');
        currentTab = newTab;
    }

    setInterval(function () {
        if (typeof (validSchools[$('#schoolname').val().toLowerCase()]) == 'undefined') {
            $('.proceedto-auth').addClass('disabled');
        } else {
            $('.proceedto-auth').removeClass('disabled');
        }
    }, 500);

    setInterval(function () {
        if ($("#username").val().length > 0 && $("#password").val().length) {
            $('.proceedto-login').removeClass('disabled');
        } else {
            $('.proceedto-login').addClass('disabled');
        }
    }, 500);

    setInterval(function () {
        $(".tab:not(.tab-" + currentTab + ")").hide();
    }, 500);
</script>


</html>